{% extends "base.html" %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
        <div>
            <h2 class="text-3xl font-black text-slate-900 dark:text-white font-display">Takvimim</h2>
            <p class="text-slate-500 font-medium mt-1">Planladƒ±ƒüƒ±n etkinlikler burada.</p>
        </div>

        <div class="flex items-center gap-4 bg-slate-100 dark:bg-slate-800 p-1 rounded-xl self-start md:self-auto">
            <button onclick="switchView('list')" id="btn-list"
                class="px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm bg-white dark:bg-slate-700 text-primary dark:text-white">
                Liste üìã
            </button>
            <button onclick="switchView('grid')" id="btn-grid"
                class="px-4 py-2 rounded-lg text-sm font-bold transition text-slate-500 hover:text-slate-700 dark:text-slate-400">
                Aylƒ±k üìÖ
            </button>
        </div>
    </div>

    <!-- VIEW: LIST -->
    <div id="view-list" class="view-section">
        <div id="calendar-container" class="space-y-8">
            <div class="text-center py-12">
                <div class="animate-spin text-4xl mb-2">‚è≥</div>
                <p class="text-gray-400">Y√ºkleniyor...</p>
            </div>
        </div>
    </div>

    <!-- VIEW: GRID -->
    <div id="view-grid" class="view-section hidden">
        <div
            class="bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
            <!-- Grid Header -->
            <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex items-center justify-between">
                <h3 id="grid-month-title" class="text-xl font-bold text-slate-900 dark:text-white capitalize">--</h3>
                <div class="flex gap-2">
                    <button onclick="changeMonth(-1)"
                        class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">‚¨ÖÔ∏è</button>
                    <button onclick="changeMonth(1)"
                        class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">‚û°Ô∏è</button>
                </div>
            </div>

            <!-- Grid Days Header -->
            <div
                class="grid grid-cols-7 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-100 dark:border-slate-700">
                <div class="py-3 text-center text-xs font-bold text-slate-400 uppercase">Pzt</div>
                <div class="py-3 text-center text-xs font-bold text-slate-400 uppercase">Sal</div>
                <div class="py-3 text-center text-xs font-bold text-slate-400 uppercase">√áar</div>
                <div class="py-3 text-center text-xs font-bold text-slate-400 uppercase">Per</div>
                <div class="py-3 text-center text-xs font-bold text-slate-400 uppercase">Cum</div>
                <div class="py-3 text-center text-xs font-bold text-slate-400 uppercase text-orange-500">Cmt</div>
                <div class="py-3 text-center text-xs font-bold text-slate-400 uppercase text-orange-500">Paz</div>
            </div>

            <!-- Grid Cells -->
            <div id="grid-cells" class="grid grid-cols-7 auto-rows-fr bg-slate-100 dark:bg-slate-700 gap-px">
                <!-- Cells generated by JS -->
            </div>
        </div>
    </div>

    <div id="empty-state"
        class="hidden text-center py-16 bg-white dark:bg-slate-800 rounded-3xl border border-dashed border-gray-300 dark:border-slate-700 mt-8">
        <div class="text-6xl mb-4">üìÖ</div>
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Takvimin Bo≈ü</h3>
        <p class="text-gray-500 mb-6">Hen√ºz bir etkinlik eklemedin.</p>
        <a href="/dashboard"
            class="bg-primary text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition">Etkinlik
            Ke≈üfet</a>
    </div>

</div>

<!-- Day Details Modal -->
<div id="day-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeDayModal()"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center">
            <div
                class="relative transform overflow-hidden rounded-2xl bg-white dark:bg-slate-900 text-left shadow-xl transition-all sm:w-full sm:max-w-md border border-slate-100 dark:border-slate-700">
                <div class="bg-indigo-600 px-4 py-3 flex justify-between items-center">
                    <h3 class="text-white font-bold" id="day-modal-title">Etkinlikler</h3>
                    <button onclick="closeDayModal()" class="text-white/80 hover:text-white">‚úï</button>
                </div>
                <div id="day-modal-content"
                    class="p-4 space-y-3 bg-slate-50 dark:bg-slate-800/50 max-h-[60vh] overflow-y-auto">
                    <!-- Events -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let allEvents = [];
    let currentGridDate = new Date();

    document.addEventListener('DOMContentLoaded', loadCalendar);

    function switchView(view) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${view}`).classList.remove('hidden');

        // Update Buttons
        const btnList = document.getElementById('btn-list');
        const btnGrid = document.getElementById('btn-grid');

        if (view === 'list') {
            btnList.className = "px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm bg-white dark:bg-slate-700 text-primary dark:text-white";
            btnGrid.className = "px-4 py-2 rounded-lg text-sm font-bold transition text-slate-500 hover:text-slate-700 dark:text-slate-400";
        } else {
            btnGrid.className = "px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm bg-white dark:bg-slate-700 text-primary dark:text-white";
            btnList.className = "px-4 py-2 rounded-lg text-sm font-bold transition text-slate-500 hover:text-slate-700 dark:text-slate-400";
            renderMonthGrid(); // Render when switching
        }
    }

    async function loadCalendar() {
        try {
            const res = await fetch('/api/calendar/events');
            const events = await res.json();
            allEvents = events; // Store globally

            const container = document.getElementById('calendar-container');
            const emptyState = document.getElementById('empty-state');

            container.innerHTML = '';

            if (!events || events.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            renderListView(events);
            renderMonthGrid(); // Prepare grid too

        } catch (e) {
            console.error(e);
            document.getElementById('calendar-container').innerHTML = '<p class="text-red-500 text-center">Y√ºklenirken hata olu≈ütu.</p>';
        }
    }

    function renderListView(events) {
        const container = document.getElementById('calendar-container');
        // Group by Month
        const groups = {};
        events.forEach(evt => {
            const date = new Date(evt.event_date || Date.now());
            const monthKey = date.toLocaleString('tr-TR', { month: 'long', year: 'numeric' });
            if (!groups[monthKey]) groups[monthKey] = [];
            groups[monthKey].push(evt);
        });

        for (const [month, list] of Object.entries(groups)) {
            // Month Header
            const monthHeader = document.createElement('h3');
            monthHeader.className = "text-xl font-black text-slate-800 dark:text-slate-200 sticky top-20 bg-gray-50/95 dark:bg-slate-900/95 backdrop-blur py-3 z-10 border-b border-gray-100 dark:border-slate-800";
            monthHeader.innerText = month;
            container.appendChild(monthHeader);

            const grid = document.createElement('div');
            grid.className = "grid gap-4 mt-4 mb-8";

            list.forEach(evt => {
                const dateObj = new Date(evt.event_date);
                const day = dateObj.getDate();
                const weekday = dateObj.toLocaleString('tr-TR', { weekday: 'long' });
                const time = dateObj.toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit' });

                // Check if passed
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                const isPassed = dateObj < now;

                const el = document.createElement('div');
                el.className = `bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 flex gap-4 items-center group relative overflow-hidden transition ${isPassed ? 'opacity-60 grayscale' : ''}`;

                el.innerHTML = `
                    <div class="flex-shrink-0 w-16 text-center bg-gray-100 dark:bg-slate-700 rounded-xl py-2 flex flex-col justify-center">
                        <span class="text-2xl font-black text-slate-800 dark:text-white leading-none">${day}</span>
                        <span class="text-[10px] uppercase font-bold text-slate-500">${weekday.substring(0, 3)}</span>
                    </div>
                    
                    <div class="flex-grow min-w-0">
                            ${isPassed ? '<span class="inline-block bg-slate-200 text-slate-500 text-[10px] font-bold px-1.5 py-0.5 rounded mb-1">GE√áMƒ∞≈û ETKƒ∞NLƒ∞K</span>' : ''}
                            <div class="text-xs font-bold text-primary mb-0.5">${time != '00:00' ? time : 'G√ºn Boyu'}</div>
                            <h4 class="font-bold text-slate-900 dark:text-white text-lg truncate ${isPassed ? 'line-through decoration-slate-400' : ''}">${evt.name}</h4>
                            <p class="text-sm text-slate-500 truncate">üìç ${evt.raw_data.venue ? evt.raw_data.venue.name : 'Mekan Belirsiz'}</p>
                    </div>
                    
                    <div class="flex-none flex items-center gap-2">
                            <a href="${evt.ticket_url || evt.url || '#'}" target="_blank" class="p-2 text-gray-400 hover:text-primary transition" title="Bilet Al / Detay">‚Üó</a>
                            <button onclick="removeFromCalendar(${evt.id})" class="p-2 text-gray-400 hover:text-red-500 transition" title="Kaldƒ±r">üóëÔ∏è</button>
                    </div>
                    `;
                grid.appendChild(el);
            });
            container.appendChild(grid);
        }
    }

    /* --- GRID LOGIC --- */
    function changeMonth(delta) {
        currentGridDate.setMonth(currentGridDate.getMonth() + delta);
        renderMonthGrid();
    }

    function renderMonthGrid() {
        if (!allEvents) return;

        const year = currentGridDate.getFullYear();
        const month = currentGridDate.getMonth();

        // Update Title
        document.getElementById('grid-month-title').innerText = currentGridDate.toLocaleString('tr-TR', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1).getDay(); // 0=Sun, 1=Mon...
        // Adjust for TR (Monday start): Sun(0)->6, Mon(1)->0
        const startOffset = firstDay === 0 ? 6 : firstDay - 1;

        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const cellsContainer = document.getElementById('grid-cells');
        cellsContainer.innerHTML = '';

        // Empty slots
        for (let i = 0; i < startOffset; i++) {
            const empty = document.createElement('div');
            empty.className = "bg-white dark:bg-slate-800 h-24 sm:h-32 opacity-50";
            cellsContainer.appendChild(empty);
        }

        // Days
        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const dayEvents = allEvents.filter(e => e.event_date && e.event_date.startsWith(dateStr));

            const cell = document.createElement('div');
            cell.className = "bg-white dark:bg-slate-800 h-24 sm:h-32 p-2 relative hover:bg-indigo-50 dark:hover:bg-slate-700/50 transition cursor-pointer flex flex-col items-start gap-1 group";
            cell.onclick = () => { if (dayEvents.length) openDayModal(dateStr, dayEvents) };

            // Number
            cell.innerHTML = devHTML(d, dayEvents);
            cellsContainer.appendChild(cell);
        }
    }

    function devHTML(d, dayEvents) {
        let html = `<span class="text-sm font-bold text-slate-400 group-hover:text-primary">${d}</span>`;
        if (dayEvents.length > 0) {
            html += `<div class="w-full flex flex-col gap-1 mt-1">`;
            dayEvents.forEach(e => {
                html += `<div class="w-2 h-2 rounded-full bg-indigo-500 inline-block mr-1" title="${e.name}"></div>`;
            });
            // Text Preview for larger screens?
            dayEvents.slice(0, 2).forEach(e => {
                html += `<div class="hidden sm:block text-[10px] leading-tight text-slate-600 dark:text-slate-300 truncate w-full px-1 rounded bg-slate-100 dark:bg-slate-700">${e.name}</div>`;
            });
            if (dayEvents.length > 2) {
                html += `<div class="hidden sm:block text-[9px] text-gray-400">+${dayEvents.length - 2}</div>`;
            }
            html += `</div>`;
        }
        return html;
    }

    function openDayModal(dateStr, events) {
        const date = new Date(dateStr);
        document.getElementById('day-modal-title').innerText = date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });

        const content = document.getElementById('day-modal-content');
        content.innerHTML = events.map(e => `
            <div class="bg-white dark:bg-slate-900 p-3 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex gap-3 items-center">
                 <div class="w-12 h-12 rounded-lg bg-slate-200 flex-shrink-0 overflow-hidden">
                     <img src="${e.poster_url || e.image || ''}" class="w-full h-full object-cover">
                 </div>
                 <div class="flex-grow min-w-0">
                     <h4 class="text-sm font-bold text-slate-800 dark:text-white truncate">${e.name}</h4>
                     <p class="text-xs text-slate-500">${e.raw_data.venue ? e.raw_data.venue.name : 'Mekan?'}</p>
                 </div>
                 <a href="${e.ticket_url || e.url}" target="_blank" class="px-3 py-1.5 bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-white text-xs font-bold rounded-lg hover:bg-indigo-200">Git</a>
            </div>
         `).join('');

        document.getElementById('day-modal').classList.remove('hidden');
    }

    function closeDayModal() {
        document.getElementById('day-modal').classList.add('hidden');
    }

    async function removeFromCalendar(id) {
        if (!confirm('Bu etkinliƒüi takvimden silmek istediƒüine emin misin?')) return;

        try {
            await fetch('/api/calendar/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            loadCalendar(); // Reload
        } catch (e) {
            alert('Hata olu≈ütu');
        }
    }
</script>
{% endblock %}