{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <div
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden border border-slate-100 dark:border-slate-700">
        <div class="md:flex">
            <!-- Sidebar -->
            <div class="bg-slate-50 dark:bg-slate-900/50 p-8 md:w-1/3 border-r border-slate-100 dark:border-slate-700">
                <div class="text-center">
                    <!-- Preview Area -->
                    <div class="relative group mx-auto h-32 w-32 rounded-full shadow-xl overflow-hidden bg-white dark:bg-slate-800 ring-4 ring-white dark:ring-slate-700 cursor-pointer"
                        onclick="document.getElementById('file-upload').click()">
                        {% if user.profile_image %}
                        <img id="profile-preview" src="/static/uploads/profiles/{{ user.profile_image }}"
                            class="w-full h-full object-cover transition duration-300 group-hover:scale-105 group-hover:opacity-75">
                        {% else %}
                        <div id="profile-placeholder"
                            class="bg-gradient-to-tr from-primary to-secondary w-full h-full flex items-center justify-center text-white text-4xl font-black group-hover:opacity-75 transition">
                            {{ user.name[0] | upper }}
                        </div>
                        <img id="profile-preview" class="hidden w-full h-full object-cover">
                        {% endif %}

                        <!-- Overlay Icon -->
                        <div
                            class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300 z-10">
                            <span class="text-white bg-black/30 p-2 rounded-full backdrop-blur-sm">ğŸ“·</span>
                        </div>
                    </div>

                    <h2 class="mt-4 text-2xl font-black text-slate-900 dark:text-white font-display">{{ user.name }}
                    </h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">{{ user.email }}</p>
                </div>

                <div class="mt-8 border-t border-slate-200 dark:border-slate-700 pt-8">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Hesap Ã–zeti</h3>
                    <div class="space-y-3">
                        <div
                            class="flex items-center justify-between text-slate-600 dark:text-slate-300 text-sm bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                            <span class="font-medium">SÄ±klÄ±k:</span>
                            <span class="font-bold text-primary dark:text-indigo-400">
                                {% if user.frequency == 'weekly' %}HaftalÄ±k
                                {% elif user.frequency == 'biweekly' %}2 HaftalÄ±k
                                {% elif user.frequency == 'monthly' %}AylÄ±k
                                {% else %}{{ user.frequency }}{% endif %}
                            </span>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="p-8 md:w-2/3">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Tercihlerini DÃ¼zenle</h2>
                    <span class="text-2xl">âš™ï¸</span>
                </div>


                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                {% for category, message in messages %}
                <div
                    class="mb-6 p-4 rounded-xl font-bold text-sm shadow-sm {{ 'bg-green-50 text-green-700 border border-green-200' if category == 'success' else 'bg-red-50 text-red-700 border border-red-200' }}">
                    {{ message }}
                </div>
                {% endfor %}
                {% endif %}
                {% endwith %}

                <form action="/profile" method="POST" enctype="multipart/form-data" class="space-y-8">
                    <!-- Hidden File Input -->
                    <input id="file-upload" type="file" name="profile_image" accept="image/*" class="hidden"
                        onchange="previewImage(this)">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Budget Input (Restored for editing) -->
                        <!-- Actually user wanted to REMOVE budget earlier? 
                              Let's check implementation_plan. 'Remove all price display logic'.
                              So I should probably NOT show it here as editable, but keep it in backend? 
                              Wait, line 117 of HTML shows we are displaying it. 
                              The prompt says "remove price/budget info". 
                              Okay, I will keep it hidden or readonly if needed, but for now lets focus on the IMAGE aspect requested.
                              Actually, user.frequency is here. I will just render Frequency and Interests.
                          -->

                        <div class="col-span-full">
                            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Etkinlik
                                SÄ±klÄ±ÄŸÄ±</label>
                            <select name="frequency"
                                class="block w-full rounded-xl border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white shadow-sm focus:border-primary focus:ring focus:ring-primary/20 transition py-3">
                                <option value="weekly" {% if user.frequency=='weekly' %}selected{% endif %}>Haftada Bir
                                </option>
                                <option value="biweekly" {% if user.frequency=='biweekly' %}selected{% endif %}>Ä°ki
                                    Haftada Bir</option>
                                <option value="monthly" {% if user.frequency=='monthly' %}selected{% endif %}>Ayda Bir
                                </option>
                                <option value="rarely" {% if user.frequency=='rarely' %}selected{% endif %}>Nadir
                                </option>
                            </select>
                            <p class="mt-2 text-xs text-slate-400">Ne sÄ±klÄ±kla etkinlik Ã¶nerisi almak istersin?</p>
                        </div>
                    </div>


                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">Ä°lgi
                            AlanlarÄ±</label>
                        <div class="grid grid-cols-2 gap-4">
                            {% set interest_list = user.interests_list %}
                            {% for val, label in [('konser', 'Konser ğŸµ'), ('tiyatro', 'Tiyatro ğŸ­'), ('sinema', 'Sinema
                            ğŸ¬'), ('festival', 'Festival ğŸª'), ('spor', 'Spor âš½'), ('sanat', 'Sanat ğŸ¨'), ('atolye',
                            'AtÃ¶lye ğŸ› ï¸')] %}
                            <label
                                class="relative flex items-center p-4 border rounded-xl cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition duration-200 group {{ 'border-primary bg-indigo-50 dark:bg-indigo-900/20 dark:border-indigo-500' if val in interest_list else 'border-slate-200 dark:border-slate-700' }}">
                                <input type="checkbox" name="interests" value="{{ val }}"
                                    class="h-5 w-5 text-primary focus:ring-primary border-gray-300 rounded transition"
                                    {% if val in interest_list %}checked{% endif %}>
                                <span
                                    class="ml-3 text-sm font-bold text-slate-700 dark:text-slate-200 group-hover:text-primary dark:group-hover:text-white transition">{{
                                    label }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="pt-4 flex items-center justify-end gap-4">
                        <button type="button" onclick="document.getElementById('file-upload').click()"
                            class="text-sm font-bold text-slate-500 hover:text-primary transition underline">
                            FotoÄŸraf DeÄŸiÅŸtir
                        </button>
                        <button type="submit"
                            class="inline-flex justify-center py-3 px-8 border border-transparent rounded-xl shadow-lg shadow-indigo-500/20 text-sm font-bold text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition transform hover:-translate-y-0.5">
                            DeÄŸiÅŸiklikleri Kaydet
                        </button>
                    </div>
                </form>

                <!-- Interaction History (Collapsible) -->
                <div class="mt-12 border-t border-slate-100 dark:border-slate-700 pt-8">
                    <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-6">EtkileÅŸim GeÃ§miÅŸi</h2>

                    <div class="space-y-4">
                        <!-- Likes Drawer -->
                        <details
                            class="group bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 overflow-hidden open:shadow-lg transition-all duration-300">
                            <summary
                                class="flex items-center justify-between p-6 cursor-pointer bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-700 transition select-none">
                                <div class="flex items-center gap-3">
                                    <span
                                        class="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 p-2 rounded-lg text-lg">ğŸ‘</span>
                                    <div>
                                        <h3 class="font-bold text-slate-900 dark:text-white">BeÄŸendiklerim</h3>
                                        <p class="text-xs text-slate-400">{{ liked_events|length }} etkinlik</p>
                                    </div>
                                </div>
                                <span
                                    class="transform transition-transform group-open:rotate-180 text-slate-400">â–¼</span>
                            </summary>

                            <div class="p-6 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800">
                                <div
                                    class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[500px] overflow-y-auto custom-scrollbar">
                                    {% if not liked_events %}
                                    <p class="text-slate-400 text-sm italic col-span-full text-center py-4">HenÃ¼z bir
                                        etkinlik beÄŸenmedin.</p>
                                    {% endif %}
                                    {% for event in liked_events %}
                                    <div id="hist-{{ event.id }}"
                                        class="flex gap-3 p-3 rounded-xl bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md transition group relative">
                                        <img src="{{ event.poster_url or event.image }}"
                                            class="w-16 h-16 rounded-lg object-cover bg-slate-200">
                                        <div class="overflow-hidden flex-1">
                                            <div
                                                class="text-[10px] items-center text-green-600 dark:text-green-400 font-bold uppercase mb-0.5">
                                                {{ event.category.name if event.category else 'Etkinlik' }}
                                            </div>
                                            <h4
                                                class="font-bold text-slate-800 dark:text-slate-200 text-sm leading-tight line-clamp-1 mb-1">
                                                {{ event.name }}</h4>
                                            <p class="text-slate-400 text-xs truncate">ğŸ“ {{ event.venue.name if
                                                event.venue else 'Mekan?' }}</p>
                                        </div>
                                        <button onclick="deleteInteraction('{{ event.id }}', this)"
                                            class="absolute top-2 right-2 p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition opacity-0 group-hover:opacity-100"
                                            title="GeÃ§miÅŸten Sil">
                                            ğŸ—‘ï¸
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </details>

                        <!-- Dislikes Drawer -->
                        <details
                            class="group bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 overflow-hidden open:shadow-lg transition-all duration-300">
                            <summary
                                class="flex items-center justify-between p-6 cursor-pointer bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-700 transition select-none">
                                <div class="flex items-center gap-3">
                                    <span
                                        class="bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 p-2 rounded-lg text-lg">ğŸ‘</span>
                                    <div>
                                        <h3 class="font-bold text-slate-900 dark:text-white">Ä°lgilenmediklerim</h3>
                                        <p class="text-xs text-slate-400">{{ disliked_events|length }} etkinlik</p>
                                    </div>
                                </div>
                                <span
                                    class="transform transition-transform group-open:rotate-180 text-slate-400">â–¼</span>
                            </summary>

                            <div class="p-6 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800">
                                <div
                                    class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[500px] overflow-y-auto custom-scrollbar opacity-75">
                                    {% if not disliked_events %}
                                    <p class="text-slate-400 text-sm italic col-span-full text-center py-4">HenÃ¼z pas
                                        geÃ§tiÄŸin etkinlik yok.</p>
                                    {% endif %}
                                    {% for event in disliked_events %}
                                    <div id="hist-{{ event.id }}"
                                        class="flex gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-100 dark:border-slate-700 grayscale hover:grayscale-0 transition group relative">
                                        <img src="{{ event.poster_url or event.image }}"
                                            class="w-16 h-16 rounded-lg object-cover bg-slate-200">
                                        <div class="overflow-hidden flex-1">
                                            <div
                                                class="text-[10px] items-center text-slate-500 font-bold uppercase mb-0.5">
                                                {{ event.category.name if event.category else 'Etkinlik' }}
                                            </div>
                                            <h4
                                                class="font-bold text-slate-600 dark:text-slate-400 text-sm leading-tight line-clamp-1 mb-1">
                                                {{ event.name }}</h4>
                                            <p class="text-slate-400 text-xs truncate">Pas geÃ§ildi</p>
                                        </div>
                                        <button onclick="deleteInteraction('{{ event.id }}', this)"
                                            class="absolute top-2 right-2 p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition opacity-0 group-hover:opacity-100"
                                            title="GeÃ§miÅŸten Sil">
                                            ğŸ—‘ï¸
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
                const preview = document.getElementById('profile-preview');
                const placeholder = document.getElementById('profile-placeholder');

                if (preview) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                }
                if (placeholder) placeholder.classList.add('hidden');
            }

            reader.readAsDataURL(input.files[0]);
        }
    }

    async function deleteInteraction(eventId, btn) {
        if (!confirm('Bu etkinliÄŸi geÃ§miÅŸinden silmek istediÄŸine emin misin?')) return;

        try {
            const res = await fetch('/api/interact', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ event_id: eventId, action: 'delete' })
            });

            if (res.ok) {
                // Remove element visually
                const card = document.getElementById(`hist-${eventId}`);
                if (card) {
                    card.style.transition = 'all 0.3s ease';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';
                    setTimeout(() => card.remove(), 300);
                }
            }
        } catch (e) {
            console.error(e);
            alert('Bir hata oluÅŸtu.');
        }
    }
</script>
{% endblock %}